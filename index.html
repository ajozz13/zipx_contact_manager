<!DOCTYPE html>
<html>
<head>
<title>Zipx Address Book Manager</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="shortcut icon" href="http://www.ibcinc.com/hubfs/images/zipx/icon.ico" type="image/x-icon" />
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Abel">
<link rel="stylesheet"type="text/css"  href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css"  media="screen,projection"/>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>
<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.13.1/jquery.validate.min.js"></script>
<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jquery.validate/1.13.1/additional-methods.min.js"></script>
<script type="text/javascript" src="http://cdn.wijmo.com/external/globalize.min.js"></script>
<script type="text/javascript" src="http://www.ibcinc.com/hubfs/compose/libs/table/jquery.tabletojson.min.js"></script>
<style>
	body{ font-family: 'Abel', sans-serif; font-size: 1.5em; }
	.bar{ background-color: #E57373;}
	.smalltxt{ font-size: .80em;}
	.smallertxt{ font-size: .75em;}
	.error{ font-size: .80em; color: #F44336; } 
	.fleft { float: left; }
	.fright { float: right; }
	.mright { margin: 10px; }
</style>
<script>
	var service_label = "Provide Service";
	var no_service_label = "Do not Provide Service";
	function displayAlert( msg ){
		console.log( msg );
		Materialize.toast( msg, 4000);
	}
	function getServiceHost(){
		$( "#innerContent" ).html( $("#preloader-big" ).html() );
		return "https://api.pactrak.com";
		//return window.location.protocol+"//"+window.location.hostname+":"+window.location.port;
	}
	
	function tokenTest(){
		if( !$( '#token' ).val() ) { displayAlert( "Please log in first." ); return false;  }else{ return true; }
	}
	
	function getServiceURL( app ){ 
		if( tokenTest() ){
			var token = $( '#token' ).val();
			return getServiceHost()+"/"+app+"?token="+token; 
		}
	} 
	
	function sendJSONRequest( type, url, data, success_function, error_function ){
		console.log( type+" on: "+url );
		if ( success_function===undefined ) success_function = default_success;
		if ( error_function===undefined ) error_function = default_error;
		$.ajax({ type: type, url: url, data: data, dataType: "json", contentType: "application/json;charset=utf-8", success: success_function, error: error_function });
	}
	function default_success( data ){ console.log( data ); displayAlert( data ); }
	function default_error( data ){ 
		var json_resp = JSON.parse( data.responseText ); 
		console.log( json_resp.message+"\n"+json_resp.developerMessage );	
		displayAlert(  json_resp.message );
	}
	function head_success( data, status, httpRequest ){
		var b64token = httpRequest.getResponseHeader("Authority");
		var decoded = window.atob( b64token ).split( "|" );
		$("#token").val( b64token );
		$( "#logon_msg" ).html( "<b>Authenticated</b>" );
		$( "#entrysection" ).show( 1500, function(){  toggleMe( "#float_btn" ); $( "#innerContent" ).empty(); } );
	}
	function head_failure( httpRequest ){
		var msg = httpRequest.getResponseHeader("Authority"); 
		$( "#logon_msg" ).html( "Not authorized. [ "+msg+" ]");
		$( "#entrysection" ).hide( 1500, function(){ toggleMe( "#float_btn" ); } );
		console.log( "Server Response: "+ msg );
		$( "#innerContent" ).empty();
	}
	//Display Table content
	function displayTable( jsonArray ){
		$( "#innerContent" ).empty();
		var d = $("<div>").append( $("<h2>").text( "Station Address Book List" ) );
		var m = $( "<ul/>" ).addClass( 'collection' );

		$.each( jsonArray, function( k, v ){
			var li = $( "<li/>" ).addClass( 'collection-item avatar' );
			var i = $( "<i/>" ).addClass( 'material-icons circle' ).text( 'folder' );
			var title = $( "<span/>").addClass( 'title' );
			var l1 = $( "<p/>" );
			var l2 = $( "<p/>" );
			var sec = $( "<a href='#!' class='secondary-content'> " );
			sec.append( $( "<i class='material-icons'>" ).text( 'mode edit' ) );
			//l1.empty(); title.empty();
			title.append( v.account );
			l1.append( v.name );
			l2.append( presentFlatEntryValuesTable( v, 'address1', 'address2', 'city', 'state', 'zip', 'country', 'contact', 'phone', 'comments' ) );
			//var l2 = joinIntoSpan( v.address1, v.address2, v.city, v.state, v.zip, v.country, v.contact, v.phone, v.comments );
			li.append( i ).append( title ).append( l1 ).append( l2 ).append( sec );
			m.append( li );
		});
		$( "#innerContent" ).html( d.append( m ) );
		
	}
	
	function displayTableAccordion( jsonArray ){
		$( "#innerContent" ).empty();
		var d = $("<div/>").append( $("<h2>").text( "Station Address Book List" ) );
		var m = $( "<ul/>" ).addClass( 'collapsible' ).attr( {"data-collapsible": "accordion", "id": "entrylist"} );

		$.each( jsonArray, function( k, o ){
			var v = o.customer;
			var li = $( "<li/>" );
			var header = $( "<div/>" ).addClass( "collapsible-header" );
			var i = $( "<i/>" ).addClass( 'material-icons editme' ).text( 'subtitles' );
			var sec = $( "<a/>" ).attr( "href", "#!").addClass( "secondary-content" );
			var body = $( "<div/>" ).addClass( "collapsible-body" ).attr( "for", v.account );
			var upd = $( "<i/>" ).addClass( 'material-icons' ).attr( "for", v.account ).text( 'mode edit' ); //.attr( 'type', 'update' );
			upd.click(function( event ) {
				console.log( 'Update button clicked '+$(this).attr( 'for' ) );
				var div = $( "div[for="+$(this).attr( 'for' ) +"]" );
				var autoclose = false;
				if( div.is( ":hidden" ) ) { div.show(); autoclose = true; }
				var arr = div.find( "table" ).tableToJSON();
				if( autoclose ) div.hide();
				
				var obj;
				if ( arr.length === 0 ){
					obj = {};
				}else{
					obj = arr[ 0 ];	
				}
				obj['account'] = v.account;
				//obj['name'] = v.name;
				
				//console.log( JSON.stringify( obj ) );
				setupUpdateForm( obj );
				
				event.preventDefault();
			});
			
			sec.append( upd );  //$( "<i class='material-icons' type='update'>" ).attr( "for", v.account ).text( 'mode edit' )
			var lt = $( "<span/>" ).addClass( "col s5" ).append( i ).append( joinIntoSpan( v.account, v.name ) );
		
			header.append( lt ); //.append( rt );
			//console.log( JSON.stringify( v ) ); 
			var l1 = $( "<p/>" );
			l1.append( presentFlatEntryValuesTable( v, 'address1', 'address2', 'city', 'state', 'zip', 'country', 'contact', 'phone', 'comments' ) );
			body.append( l1 );
			var t = presentEntryContacts( v.account, o.customer_contacts, "Contacts" );
			body.append(  t  );
			
			
			li.append( setServiceSwitch( v.provide_service, v.account )  ).append( sec ).append( header ).append( body );
			m.append( li );
		});
		$( "#innerContent" ).html( d.append( m ) );
		//assignAnchorOptions( "#entrylist" );
		$( "#entrylist").collapsible();
	}
	
	function joinIntoSpan(){
		var l = $( "<span/>" );
		for( var i=0; i < arguments.length; i++) {
			if( i > 0 ){ l.append( "&nbsp;" ); }
			if ( arguments[i] ){ l.append( $('<span>').text( arguments[i] ) ); }
		}
		return l;
	}
	function toTableRow(){
		var r = $( "<tr/>" );
		for( var i=0; i < arguments.length; i++) {
			r.append(  $( "<td/>" ).html( arguments[ i ] ) );
		}
		return r; 
	}
	
	function toTableHeaderRow(){
		var r = $( "<tr/>" );
		for( var i=0; i < arguments.length; i++) {
			r.append(  $( "<th/>" ).html( arguments[ i ] ) );
		}
		return r; 
	}
	/* 
	 *  This function expects as the first parameter the Object and then a list of the object keys to display.
	 */
	function presentEntryValuesTable(){
		var table = $( "<table/>" ).addClass( 'responsive-table striped smallertxt' );
		var obj = arguments[ 0 ];
		for( var i=1; i < arguments.length; i++) {
			var title = arguments[ i ];
			if( obj[ title ] ){
				var t = $( "<b/>" ).text( title+":" );
				table.append( toTableRow( t, obj[ title ] ) );
			}
		}
		return table;
	}
	
	function presentFlatEntryValuesTable(){
		var obj = arguments[ 0 ];
		var table = $( "<table/>" ).addClass( 'responsive-table striped smallertxt' );//.attr( 'for', obj['account'] );
		//var cap = $("<caption/>").html( $("<h3/>").text( "Details" ) );
		var thead = $( "<thead/>" );
		var header = $( "<tr/>" );
		var row = $( "<tr/>");
		var hasValues = false;
		
		for( var i=1; i < arguments.length; i++) {
			var title = arguments[ i ];
			if( obj[ title ] ){
				header.append( $("<th/>").text( title ) );
				row.append( $("<td/>").text( obj[ title ] ) );
				if( !hasValues ) hasValues = true;
			}
		}
		if( hasValues )
			table.append( thead.append( header ) ).append( row );
		return table;
	}
	
	function presentEntryContacts( account, arrayContact, tableCaption ){
		var l2 = $( "<p/>" );
		var sec = $( "<a/>" ).attr( "href", "#!").addClass( "secondary-content modal-trigger" );
		sec.append( $( "<i class='material-icons'>" ).attr( "for", account ).text( 'add' ) );
		sec.click(function( event ){
			//console.log( "Add a new contact for "+ $(this).find("i").attr('for') );
			clearForm( $( "#contactForm" ) );
			$( "#contactId" ).text( $(this).find("i").attr('for') );
			$("#addContact").openModal();
		});
		var list = $( "<ul/>").addClass( "collection with-header").attr( "for", account );
		var h = $( "<li/>" ).addClass("collection-header").append( $("<h4/>").text( tableCaption ).append( sec ) );
		list.append( h );
		var item = $( "<li/>" ).addClass( "collection-item" );
		list.append( createEntryItem( arrayContact, account ) );
		return l2.append( list );		
	}
	
	function createEntryItem( arrayContact, account ){
		var table = createHTMLContactTable();
		if( arrayContact ){
			$.each( arrayContact, function( k, v ){
				table.append( toHTMLContactRow( v ) );
			});
		}
		//table.find( 'tr:last' ).append($( "<td/>" ).html( sec2 ) );
		return $( "<li/>" ).addClass( "collection-item" ).attr( "contact", account  ).html( table );
	}
	
	function createHTMLContactTable( title ){
		//console.log( JSON.stringify( obj ) );
		var table = $( "<table/>" ).addClass( 'responsive-table smallertxt' );
		if( title ){
			var cap = $("<caption/>").html( title );
			table.append( cap );
		}
		
		var thead = $( "<thead/>" );
		var hdrs = [ "name", "phone", "description", "email",  "send_notices" ];
		thead.append( toTableHeaderRow.apply( this, hdrs ) ) ;
		table.append( thead );
		return table;
	}
	
	function toHTMLContactRow( v ){
		var vals = [  v.name ];
		( v.phone ) ? vals.push( v.phone ) : vals.push( "" );
		( v.description ) ? vals.push( v.description ) : vals.push( "" );
		( v.email ) ? vals.push( v.email ) : vals.push( "" );
		vals.push( setNoticeSwitch( v.send_notices, v.id, v.name ) );
		var row = toTableRow.apply( this, vals );
		var sec2 = $( "<a/>" ).attr( "href", "#!").addClass( "secondary-content" );
		sec2.append( $( "<i class='material-icons'>" ).attr( {"for": v.id, "name": v.name } ).text( 'delete' ) );
		sec2.click(function( event ){
			//console.log( "ID: "+$(this).find("i").attr('for')  );
			//console.log( "NAME: "+$(this).find("i").attr('name')  );
			var id = $(this).find("i").attr('for');
			var n = $(this).find("i").attr('name');
			
				var url = getServiceURL( "zipx/addresses/"+id+"/contacts" );
				//url = url.concat( "&"+$.param( { name : n } ) );
				//
				sendJSONRequest( "DELETE", url,JSON.stringify( { name : n } ), function( data ){
					//console.log( "service completed: " + JSON.stringify( data ) );
					var row = sec2.closest("tr");
					row.effect( "highlight",  { color: '#FF8566' }, 3500 ).fadeOut( 300, function() {
						$( this ).remove();
					}); 
				});
		});
		row.append( $("<td />").html( sec2 ) );
		return row;
	}
	
	/* return the html tag turned off or on depending on input value either Y or N */
	function setServiceSwitch( value, for_id, cls ){
		var labelTxt = no_service_label;
		var input = $("<input/>").attr( {"type": "checkbox", "id":for_id } );
		if( cls !== null ){
			input.addClass( cls );
		}
		if( value.localeCompare ( "Y" ) === 0 ){
			input.attr( "checked", "");
			labelTxt = service_label;
			input.closest( "label" ).text( labelTxt );
		}
		
		var label = $("<label/>").attr( "for", for_id ).text( labelTxt );
		input.change( function(){ 
			var requesting = $(this).is(':checked');
			//console.log( 'changed forID: ' + $(this).attr( 'id' ) + "  checked "+ requesting );  
			//function sendJSONRequest( type, url, data, success_function, error_function ){
			var obj = {};
			obj["customer"] = { provide_service: requesting ? "Y" : "N" };
			sendJSONRequest("PUT", getServiceURL( "zipx/addresses/"+for_id ), JSON.stringify( obj ), function( data ){ 
				console.log( "service completed: " + JSON.stringify( data ) );
				input.next( "label" ).text( !requesting ? no_service_label: service_label );
			}, function( data ) { 
				default_error( data );
				var label = no_service_label;
				if( !requesting ){
					label = service_label;
					input.prop( "checked", "true");
				}else{
					input.removeAttr( "checked" );
				}
				input.next( "label" ).text( label );
			});	
		} );
		return $("<span/>").addClass( "mright" ).append( input ).append( label );
	}
	
	function setNoticeSwitch(value, for_id, for_name ){
		var swtch = $( "<span/>" ).addClass( "switch" );
		var label = $( "<label/>" );
		var input = $( "<input/>" ).attr( "type", "checkbox" );
		if( for_id ){ input.attr( 	"for", for_id );  }
		if( for_name ){
			input.attr( 	"for_name", for_name ); 
			input.change( function(){
					//console.log( 'changed forID: ' + $(this).attr( 'for' ) + " email: " + $(this).attr( 'for_name' )  + "  checked: "+ $(this).is(':checked') ); 
					var requesting = $(this).is(':checked');
					var for_id = $(this).attr( 'for' );
					var for_name = $(this).attr( 'for_name' );
					//function sendJSONRequest( type, url, data, success_function, error_function ){
					var obj = {};
					obj[ "id" ]= for_id;
					obj[ "name"] = for_name;
					obj["send_notices"] = requesting ? "Y" : "N";
					sendJSONRequest("PUT", getServiceURL( "zipx/addresses/"+for_id+"/contacts" ), JSON.stringify( obj ), function( data ){ 
						console.log( "service completed: " + JSON.stringify( data ) );
					}, function( data ) { 
						default_error( data );
						if( !requesting ){ input.prop( "checked", "true"); }else{ input.removeAttr( "checked" ); }
					});	
			}); 
		}
		if( value.localeCompare ( "Y" ) === 0 ){
			input.attr( "checked", "");	
		}
		var lever = $( "<span/>" ).addClass( "lever");
		
		label.append( "No" ).append( input ).append( lever ).append( " Yes" );
		swtch.append( label );
		return swtch;
	}
	function clearForm( form ){
		form.find("input[type=text], input[type=number], input[type=email], input[type=password], textarea").val("");
		form.find( 'select' ).each(function (i, v) {
			$(this).prop("selectedIndex", 0);
		});
		form.find( 'label' ).removeClass('active');
	}
	//Json creation
	function toJson( form ){
		return JSON.stringify( formToJson( form ) );
	}
	function formToJson( form, all ){
		if( all === 'undefined') all = false;
		var array = $(form).serializeArray();
		var json_obj = {};

		$.each( array, function(){
			if( all ){
				json_obj[this.name] = this.value || '';
			}else if( this.value ){
				json_obj[this.name] = this.value;
			}
		});
		return json_obj;
	}
	function toJsonObject( json_input ){
		return JSON && JSON.parse( json_input ) || $.parseJSON( json_input );
	}
	
	function setupUpdateForm( entry ){
		//entryFormModal
		var div = $( "div[for="+entry.account +"]" );
		var spn = div.prev().find( 'span' ).find('span');
		entry.name = spn.find( "span:last").text();
		$("#entryFormFooter").empty();
		clearForm( $("#entry-form") );
		$("#entryFormTitle").text( "Update entry "+ entry.account );
		fillValue( "#addaccount", entry.account, true );
		fillValue( "#addname", entry.name );
		fillValue( "#addaddress1", entry.address1 );
		fillValue( "#addaddress2", entry.address2 );
		fillValue( "#addcity", entry.city );
		fillValue( "#addstate", entry.state );
		fillValue( "#addzip", entry.zip );
		fillValue( "#addcountry", entry.country );
		fillValue( "#addcontact", entry.contact );
		fillValue( "#addphone", entry.phone );
		fillValue( "#addcomments", entry.comments );

		//<a href="#!" class="waves-effect waves-green btn-flat">Update</a>
		var upbtn = $( "<a/>").addClass( "waves-effect waves-green btn-flat" ).attr( "href", "#!" ).text( 'Update' );
		
		upbtn.click( function(e){
			//var changes = FormChangesToObject( 'entryForm' );
			//console.log( JSON.stringify( changes ) );
			
			if( $("#entry-form").valid() ){
				$( "#addaccount" ).removeAttr( "disabled" );
				//var entry = formToJson( $("#entryForm"), true );
				
				var url = getServiceURL( "zipx/addresses/"+entry.account );
				//function sendJSONRequest( type, url, data, success_function, error_function ){
				var j_obj = {};
				var v = formToJson( $("#entry-form"), true );
				j_obj["customer"] = v;
				console.log( JSON.stringify( j_obj ) );
				sendJSONRequest( "PUT", url, JSON.stringify( j_obj ), function( data){
					$( "#entryFormModal" ).closeModal();
					var div = $( "div[for="+v.account +"]" );
					var spn = div.prev().find( 'span' ).find('span');
					spn.empty().append( joinIntoSpan( v.account, v.name ) );
					if( div.is( ":hidden" ) ) { div.show(); }
					var holder = div.find( "p:first" );
					holder.empty();
					holder.append( presentFlatEntryValuesTable( v, 'address1', 'address2', 'city', 'state', 'zip', 'country', 'contact', 'phone', 'comments' ) );
					holder.effect( "highlight",  { color: '#FFFF50' }, 3500 );
				});
			}
		});
		
		$("#entryFormFooter").append( upbtn );
		$("#entryFormModal").openModal();
	}
	
	function setupNewEntryForm(){
		$("#entryFormFooter").empty();
		clearForm( $("#entry-form") );
		$("#entryFormTitle").text( "Add a new address" );
		
		var adbtn = $( "<a/>").addClass( "waves-effect waves-green btn-flat" ).attr( "href", "#!" ).text( 'Add' );
		adbtn.click( function(e){
			if( $("#entry-form").valid() ){
				var acct = $( "#addaccount" ).val().substring(0, 2);
				var j_obj = {};
				var cust = formToJson( "#entry-form" );
				cust['provide_service'] = 'Y';
				j_obj["customer"] = cust;
				sendJSONRequest("POST", getServiceURL( "zipx/addresses/"+acct ), JSON.stringify( j_obj ), function( data ){ 
					console.log( "service completed: " + JSON.stringify( data ) );
					$("#entryFormModal").closeModal();
					var arr = new Array();					
					arr.push( j_obj );
					displayTableAccordion( arr  );
				});
				
			}
		});
		$("#entryFormFooter").append( adbtn );
		$("#entryFormModal").openModal();
	}
	
	function fillValue( target, value, disableInput ){
		if ( disableInput === undefined ) disableInput = false;
		if( value ){ 
			$( target ).val( value );
			$( target ).next( "label ").addClass( "active");
		} 
		if( disableInput ) $( target ).attr( "disabled",  "");
	}
	
	function FormChangesToObject( form ) {
		// get form  http://blogs.sitepointstatic.com/examples/tech/formchanges/formchanges.js
		if (typeof form === "string") form = document.getElementById(form);
		if (!form || !form.nodeName || form.nodeName.toLowerCase() !== "form") return null;

		// find changed elements
		var changed = [], n, c, def, o, ol, opt;
		for (var e = 0, el = form.elements.length; e < el; e++) {
			n = form.elements[e];
			c = false;
			switch (n.nodeName.toLowerCase()) {
				// select boxes
				case "select":
					def = 0;
					for (o = 0, ol = n.options.length; o < ol; o++) {
						opt = n.options[o];
						c = c || (opt.selected !== opt.defaultSelected);
						if (opt.defaultSelected) def = o;
					}
					if (c && !n.multiple) c = (def !== n.selectedIndex);
					break;

				// input / textarea
				case "textarea":
				case "input":
					switch (n.type.toLowerCase()) {
						case "checkbox":
						case "radio":
							// checkbox / radio
							c = (n.checked !== n.defaultChecked);
							break;
						default:
							// standard values
							c = (n.value !== n.defaultValue);
							break;				
					}
					break;
			}

			if (c) changed.push(n['id']);
		}
		var jobj = {};
		console.log( changed );
		for( var index in changed ){
			jobj[  $( "#"+ changed[ index ] ).attr('name') ] = $( "#"+ changed[ index ] ).val();
		}
		//return changed;
		return jobj;
	}
	
	//Utilities...
	function toggleMe( target, hideF, showF ){
		if ( $( target ).is(":visible") ){
			$( target ).fadeOut( 1000, hideF );
		}else{
			$( target ).show( 'bounce', 1000, showF );
		}
	}
	
$(function(){
	$.validator.setDefaults({
		errorElement : 'div',
		highlight: function(element) { $(element).closest('input').addClass('invalid error');},  
		unhighlight: function(element) { $(element).closest('input').removeClass('invalid error');},
		errorPlacement: function(error, element) { var placement = $(element).data('error');
			if (placement) { $(placement).append(error); } else { error.insertAfter(element); }
		}
	});

	$("#logform").validate({ rules: { username: { required: true, email:true }, password: { required: true, minlength: 5 } } });
	$("#contactForm").validate( { rules: { name: { required: true, maxlength:63 }, email: { required: false, email: true, maxlength:25 }, phone:{ required: false, maxlength:25 } , description:{ required: false, maxlength:25 }  } });

	$( "#login_btn" ).click( function(){
		if( $("#logform").valid() ){
			$("#token").val(''); //.empty();
			var url = getServiceHost()+"/authority/token?_zipx";
			var creds = $( "#username" ).val()+"|"+$( "#password" ).val();
			$.ajax({ type: "HEAD", url: url, 
				beforeSend: function(request){
					request.setRequestHeader( "IBCCredentials", window.btoa( creds ) );
				},
				success:  head_success, error: head_failure  
			});
		}
	});
	$( ".resetform" ).click( function(){
		clearForm( $(this).prev("form") );
		$( "#entrysection" ).hide( 1500, function(){
			$( "#innerContent" ).empty();
			$( "#logon_msg" ).empty();
			$("#token").val('');
			toggleMe( "#float_btn" );
		} );
	});
	
	$( "#listentry").click( function(e){
		if( tokenTest() ){
			if( $("#account").val() ){
				var url = getServiceURL( "zipx/addresses/"+$("#account").val() );
				//function sendJSONRequest( type, url, data, success_function, error_function ){
				sendJSONRequest( 'GET', url, null, function( data ){
					if( $.isArray(data) ){
						displayTableAccordion( data );
					}else{
						var arr = new Array();					
						arr.push( data );
						displayTableAccordion( arr  );
					}
				});
			}else{
				displayAlert( "Please enter a value first." );
			}
		}
	});
	$("#addEntry").click( function( e ){
		setupNewEntryForm();
	});
	$("#addContactBtn").click( function( e ){
		if( $("#contactForm").valid()  ){
			var acct = $( "#contactId" ).text();
			var url = getServiceURL( "zipx/addresses/"+acct+"/contacts" ); 
			//function sendJSONRequest( type, url, data, success_function, error_function ){
			var j_obj = {};
			var contact = formToJson( "#contactForm" );
			contact['id'] = acct;
			if( contact.email ){
				contact[ 'send_notices' ] = 'Y';
			}else{
				contact[ 'send_notices' ] = 'N';
			}
			var arr = [];
			arr.push( contact );
			j_obj[ "customer_contacts" ] = arr;   //{'feed':JSON.stringify( j_obj )}
			//{"customer_contacts":[{"id":"92-0001","name":"email1","send_notices":"N","email":"test@test.com"}]}
			sendJSONRequest( 'POST', url, JSON.stringify( j_obj ), function( data ){ 
				console.log( "service completed: " + JSON.stringify( data ) );
				$("#addContact").closeModal();
				var item = toHTMLContactRow( contact );
				$("li[contact="+ contact.id +"]").find('table').append( item );
				item.effect( "highlight",  { color: '#32CD32' }, 3500 );
			});
		}
	});

});
</script>
	
</head>
<body>
<div class="container">
	<div class="row">
		<div class="col s12 bar"><h1>Zipx Address Book Manager</h1></div>
	</div>
	<div class="row">
		<div class="col s3">
			<div class="section">
			<h5>Logon</h5>
			<form id="logform">
				<div class="input-field">
				<input id="username" name="username" type="email" class="validate">
				<label for="username">Username: </label>
				</div>
				<div class="input-field">
				<input id="password" name="password" type="password" class="validate">
				<label for="password">Password:</label>
				</div>
			</form>
			<a class="btn-floating btn-small waves-effect waves-light red resetform" style="margin-right: 25px;"><i class="material-icons">refresh</i></a>
			<button class="btn waves-effect waves-light" id="login_btn">Authenticate
				<i class="material-icons right">send</i>
			</button>
				
			
			<div><span id="logon_msg" class="smalltxt"></span><input type="hidden" id="token" /></div>
			<div id='test'></div>
			</div>
			<br />
			<div class="divider"></div>
			<div class="section" id="entrysection" style='display: none;'>
			<h5>View Entries</h5>
				<div class="input-field col s6">
				<input id="account" name="account" type="text">
				<label for="account">Account or Station code: </label>
				</div>
				<div class="input-field col s6">
					<a class="btn-floating btn-small waves-effect waves-light blue" id="listentry"><i class="material-icons">view_list</i></a>
				</div>
			</div>
			<div class="divider"></div>
			
			<div class="fixed-action-btn" style="bottom: 45px; right: 24px; display: none;" id='float_btn' >
			<a class="btn-floating btn-large waves-effect waves-light blue" id="addEntry"><i class="material-icons">add</i></a>
			</div>
		</div>
		<div class="col s9">
			<div id="innerContent"></div>
			
		</div>
		
	</div>
	<!--  MODALS -->
	<div id="addContact" class="modal">
		<div class="modal-content">
		<h4>Add A new contact for <span id="contactId"></span></h4>
		<form id="contactForm">
			<div class="input-field">
			<input placeholder="                          Required. Use a unique name for each new entry ie: Email 1" id="name" name="name" type="text">
			<label for="name">Unique name: </label>
			</div>
			<div>Only one of the values below is required.</div>
			<div class="input-field">
			<input id="email" name="email" type="email">
			<label for="email">Email: </label>
			</div>
			<div class="input-field">
			<input id="phone" name="phone" type="text">
			<label for="phone">Phone: </label>
			</div>
			<div class="input-field">
			<input id="description" name="description" type="text">
			<label for="description">Description: </label>
			</div>
		</form>
		</div>
		<div class="modal-footer">
			<a href="#!" class="waves-effect waves-green btn-flat" id="addContactBtn">Add</a>
			<a href="#!" class="modal-action modal-close waves-effect waves-red btn-flat ">Cancel</a>
		</div>
	</div>
	
	<div id="entryFormModal" class="modal">
		<div class="modal-content">
		<h4 id="entryFormTitle"></h4>
		<form id="entry-form">	
			<div class='row'>
				<div class="input-field col s6">
				<input id="addaccount" name="account"  type="text" required pattern="^\d{2}-\w{1,12}$">
				<label for="addaccount">Zipx Account#</label>
				</div>
				<div class="input-field col s6">
				<input id="addname" name="name" type="text" required maxlength="30">
				<label for="addname">Name:</label>
				</div>
			</div>
			<div>The fields below are optional.</div>
			<div class='row'>
				<div class="input-field col s6">
				<input id="addaddress1" name="address1" type="text" maxlength="25">
				<label for="addaddress1">Address 1:</label>
				</div>
				<div class="input-field col s6">
				<input id="addaddress2" name="address2" type="text" maxlength="25">
				<label for="addaddress2">Address 2:</label>
				</div>
			</div>
			<div class='row'>
				<div class="input-field col s4">
				<input id="addcity" name="city" type="text" maxlength="25">
				<label for="addcity">City:</label>
				</div>
				<div class="input-field col s4">
				<input id="addstate" name="state" type="text" maxlength="2">
				<label for="addstate">State:</label>
				</div>
				<div class="input-field col s4">
				<input id="addzip" name="zip" type="text" maxlength="10">
				<label for="addzip">Zip:</label>
				</div>
			</div>
			<div class='row'>
				<div class="input-field col s4">
				<input id="addcountry" name="country" type="text" maxlength="15">
				<label for="addcountry">Country:</label>
				</div>
				<div class="input-field col s4">
				<input id="addphone" name="phone" type="text" maxlength="15">
				<label for="addphone">Phone:</label>
				</div>
				<div class="input-field col s4">
				<input id="addcontact" name="contact" type="text" maxlength="20">
				<label for="addcontact">Contact:</label>
				</div>
			</div>
			<div class='row'>
				<div class="input-field col s6">
				<input id="addcomments" name="comments" type="text" maxlength="40">
				<label for="addcomments">Comments:</label>
				</div>
			</div>
		</form>
		</div>
		<div class="modal-footer">
			<span id="entryFormFooter"></span>
			<span><a href="#!" class="modal-action modal-close waves-effect waves-red btn-flat ">Cancel</a></span>
		</div>
	</div>
</div>
	
<div id="preloader-big" style="visibility: hidden;">
<div class="preloader-wrapper big active" >
	<div class="spinner-layer spinner-blue">
	<div class="circle-clipper left">
		<div class="circle"></div>
	</div><div class="gap-patch">
		<div class="circle"></div>
	</div><div class="circle-clipper right">
		<div class="circle"></div>
	</div>
	</div>
</div>
</div>
<div  id="preloader-small" style="visibility: hidden;">
	<div class="preloader-wrapper small active">	
		<div class="spinner-layer spinner-green">
			<div class="circle-clipper left">
				<div class="circle"></div>
			</div><div class="gap-patch">
				<div class="circle"></div>
			</div><div class="circle-clipper right">
			<div class="circle"></div>
			</div>
		</div>
	</div>
</div>
<div id="progressbar" style="visibility: hidden;">
	<div class="progress">
		<div class="indeterminate"></div>
	</div>
</div>
</body>
</html>
